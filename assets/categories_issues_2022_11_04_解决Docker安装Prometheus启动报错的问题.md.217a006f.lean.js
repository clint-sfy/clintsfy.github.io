import{_ as t}from"./chunks/ArticleMetadata.e10718d6.js";import{_ as r,v as e,b as c,E as i,O as y,F as o,L as d,R as m,M as u,C as D,B as h}from"./chunks/framework.2aeb816e.js";import"./chunks/md5.772bbdf1.js";const A="/assets/202211042020211.5951b90c.png",$=JSON.parse('{"title":"解决 Docker 安装 Prometheus 启动报 permission denied 的问题","description":"","frontmatter":{"title":"解决 Docker 安装 Prometheus 启动报 permission denied 的问题","author":"查尔斯","date":"2022/11/04 20:30","categories":["Bug万象集"],"tags":["Prometheus","Docker","Linux"]},"headers":[],"relativePath":"categories/issues/2022/11/04/解决Docker安装Prometheus启动报错的问题.md","filePath":"categories/issues/2022/11/04/解决Docker安装Prometheus启动报错的问题.md","lastUpdated":1691327334000}'),F={name:"categories/issues/2022/11/04/解决Docker安装Prometheus启动报错的问题.md"},C=o("h1",{id:"解决-docker-安装-prometheus-启动报-permission-denied-的问题",tabindex:"-1"},[d("解决 Docker 安装 Prometheus 启动报 permission denied 的问题 "),o("a",{class:"header-anchor",href:"#解决-docker-安装-prometheus-启动报-permission-denied-的问题","aria-label":'Permalink to "解决 Docker 安装 Prometheus 启动报 permission denied 的问题"'},"​")],-1),g=m(`<h2 id="问题描述" tabindex="-1">问题描述 <a class="header-anchor" href="#问题描述" aria-label="Permalink to &quot;问题描述&quot;">​</a></h2><p><strong>C：</strong> 今天，笔者在使用 Docker 安装了 Prometheus 后，发现其容器没有能正常启动，而是处于持续重启的状态。笔者手动尝试了几次重启容器命令，依然如此。</p><p>遇到这种情况，单纯去盯容器运行命令哪里有错误，排查和修复就慢了，不如先看看 Prometheus 容器的日志。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;"># docker logs 容器ID/容器名称</span></span>
<span class="line"><span style="color:#F69D50;">docker</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">logs</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">prometheus</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># docker logs 容器ID/容器名称</span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">logs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">prometheus</span></span></code></pre></div><p>在容器日志中，笔者看到了几段重复性的日志内容，很显然这是几次重启容器出现的重复性日志，笔者从中截取了一段相对完整的日志内容。</p><p><img src="`+A+`" alt="202211042020211"></p><p>错误信息部分也很突出，level=error。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">caller</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">query_logger.go:90</span><span style="color:#ADBAC7;"> level</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">error</span><span style="color:#ADBAC7;"> component</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">activeQueryTracker</span><span style="color:#ADBAC7;"> msg</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;Error opening quer log file&quot;</span><span style="color:#ADBAC7;"> file</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">/opt/bitnami/prometheus/data/queries.active</span><span style="color:#ADBAC7;"> err</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;open data/queries.active: permission denied&quot;</span></span>
<span class="line"><span style="color:#F69D50;">panic:</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">Unable</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">to</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">create</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">mmap-ed</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">active</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">query</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">log</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">caller</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">query_logger.go:90</span><span style="color:#24292E;"> level</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">error</span><span style="color:#24292E;"> component</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">activeQueryTracker</span><span style="color:#24292E;"> msg</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Error opening quer log file&quot;</span><span style="color:#24292E;"> file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/opt/bitnami/prometheus/data/queries.active</span><span style="color:#24292E;"> err</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;open data/queries.active: permission denied&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">panic:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Unable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mmap-ed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">active</span><span style="color:#24292E;"> </span><span style="color:#032F62;">query</span><span style="color:#24292E;"> </span><span style="color:#032F62;">log</span></span></code></pre></div><h2 id="原因分析" tabindex="-1">原因分析 <a class="header-anchor" href="#原因分析" aria-label="Permalink to &quot;原因分析&quot;">​</a></h2><p>简单翻译一下错误信息 msg 及后面部分提示。</p><blockquote><p>信息：打开查询日志文件时出错 file=/opt/bitnami/prometheus/data/queries.active 错误：打开 data/queries.active：拒绝访问</p></blockquote><p>其中的关键信息是 <code>permission denied</code>（拒绝访问），从这字面意思上可以得知和权限有关。</p><p>为了方便大家进行原因分析，笔者把 docker-compose 的 Prometheus 部分脚本贴在下方。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#8DDB8C;">version</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&#39;3&#39;</span></span>
<span class="line"><span style="color:#8DDB8C;">services</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#8DDB8C;">prometheus</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">container_name</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">prometheus</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">image</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">bitnami/prometheus:2.38.0</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">restart</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">always</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">environment</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">      </span><span style="color:#8DDB8C;">TZ</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">Asia/Shanghai</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">ports</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">      - </span><span style="color:#96D0FF;">19090:9090</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">volumes</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">      - </span><span style="color:#96D0FF;">/opt/disk/docker/volumes/prometheus/conf:/opt/bitnami/prometheus/conf</span></span>
<span class="line"><span style="color:#ADBAC7;">      - </span><span style="color:#96D0FF;">/opt/disk/docker/volumes/prometheus/data:/opt/bitnami/prometheus/data</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">command</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">      </span><span style="color:#96D0FF;">--config.file=/opt/bitnami/prometheus/conf/prometheus.yml</span></span>
<span class="line"><span style="color:#ADBAC7;">      </span><span style="color:#96D0FF;">--web.enable-lifecycle</span></span>
<span class="line"><span style="color:#ADBAC7;">      </span><span style="color:#96D0FF;">--storage.tsdb.retention.time=90d</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">privileged</span><span style="color:#ADBAC7;">: </span><span style="color:#6CB6FF;">true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">version</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;3&#39;</span></span>
<span class="line"><span style="color:#22863A;">services</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">prometheus</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">container_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prometheus</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">bitnami/prometheus:2.38.0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">restart</span><span style="color:#24292E;">: </span><span style="color:#032F62;">always</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">environment</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">TZ</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Asia/Shanghai</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">19090:9090</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">/opt/disk/docker/volumes/prometheus/conf:/opt/bitnami/prometheus/conf</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">/opt/disk/docker/volumes/prometheus/data:/opt/bitnami/prometheus/data</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">--config.file=/opt/bitnami/prometheus/conf/prometheus.yml</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">--web.enable-lifecycle</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">--storage.tsdb.retention.time=90d</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">privileged</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span></code></pre></div><p>很明显，错误信息中的文件路径 <code>/opt/bitnami/prometheus/data/queries.active</code>，是 Prometheus 容器中的数据存储目录，笔者还将其挂载到了宿主机的 <code>/opt/disk/docker/volumes/prometheus/data</code> 目录。</p><p>关于脚本中的两个挂载目录，笔者仅提前创建了 conf 配置目录，上传了配置文件。至于这个 data 数据目录则是 Docker 在运行容器时自动在宿主机创建的。</p><p>那问题的原因已经呼之欲出了，很大可能是由于 Docker 在宿主机自动创建的 data 数据挂载目录没有写入权限。</p><h2 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-label="Permalink to &quot;解决方案&quot;">​</a></h2><p>解决起来也较为容易，给 data 目录授予写入权限就好了。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F69D50;">chmod</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">775</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">/opt/disk/docker/volumes/prometheus/data</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">chmod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">775</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/opt/disk/docker/volumes/prometheus/data</span></span></code></pre></div><p>最后再重启一下 Prometheus 容器。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F69D50;">docker</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">restart</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">prometheus</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">prometheus</span></span></code></pre></div><p>此时，再通过 <code>docker ps</code> 命令查看 Prometheus 容器的状态，已经是正常的 Up 状态了。最后，笔者也是建议大家这类挂载目录尽量提前创建和授权。</p>`,23);function k(s,v,B,b,E,_){const p=t,l=u("ClientOnly");return e(),c("div",null,[C,i(l,null,{default:y(()=>{var a,n;return[(((a=s.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=s.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(e(),D(p,{key:0,article:s.$frontmatter},null,8,["article"])):h("",!0)]}),_:1}),g])}const w=r(F,[["render",k]]);export{$ as __pageData,w as default};
