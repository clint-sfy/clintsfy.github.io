---
title: SPI
author: 阿源
date: 2024/02/20 19:30
categories:
 - MCU
tags:
 - MCU
 - SPI
---

# SPI

SPI协议是由摩托罗拉公司提出的通讯协议(Serial Peripheral Interface)，即`串行外围设备接口`， 是一种高速全双工的通信总线。它被广泛地使用在ADC、LCD等设备与MCU间，要求通讯速率较高的场合。
  学习本章时，可与I2C章节对比阅读，体会两种通讯总线的差异以及EEPROM存储器与FLASH存储器的区别。下面我们分别对SPI协议的物理层及协议层进行讲解。

## 物理层

- 所有SPI设备的SCK、MOSI、MISO分别连在一起

- 主机另外引出多条SS控制线，分别接到各从机的SS引脚

- `输出引脚配置为推挽输出`，`输入引脚配置为浮空或上拉输入`

I2C要实现半双工，经常要切换输入输出，而且I2C又要实现多主机的时钟同步和总线仲裁，所以只能选择开漏

![](https://cdn.jsdelivr.net/gh/clint-sfy/blogcdn@master/stm32/base/20240823105250.png)

SPI通讯使用3条总线及片选线，3条总线分别为SCK、MOSI、MISO，片选线为SS，它们的作用介绍如下：

(1)  SS ( Slave Select）：从`设备选择信号线`，常称为`片选信号线`，也称为NSS、CS，以下用NSS表示。当有多个SPI从设备与SPI主机相连时， 设备的其它信号线SCK、MOSI及MISO同时并联到相同的SPI总线上，即无论有多少个从设备，都共同只使用这3条总线； 而每个从设备都有独立的这一条NSS信号线，本信号线独占主机的一个引脚，即`有多少个从设备，就有多少条片选信号线`。

 I2C协议中通过设备地址来寻址、选中总线上的某个设备并与其进行通讯；而SPI协议中没有设备地址，它`使用NSS信号线来寻址`， 当主机要选择从设备时，把`该从设备的NSS信号线设置为低电平`，该从设备即被选中，`即片选有效`， 接着主机开始与被选中的从设备进行SPI通讯。所以`SPI通讯以NSS线置低电平为开始信号，以NSS线被拉高作为结束信号`。

(2) SCK (Serial Clock)：`时钟信号线`，用于通讯数据同步。它由通讯主机产生，决定了通讯的速率，不同的设备支持的最高时钟频率不一样， 如STM32的SPI时钟频率最大为fpclk/2，两个设备之间通讯时，通讯速率受限于低速设备。

(3) MOSI (Master Output， Slave Input)：`主设备输出/从设备输入引脚`。主机的数据从这条信号线输出， 从机由这条信号线读入主机发送的数据，即这条线上数据的方向为主机到从机。

(4) MISO (Master Input,，Slave Output)：`主设备输入/从设备输出引脚`。主机从这条信号线读入数据， 从机的数据由这条信号线输出到主机，即在这条线上数据的方向为从机到主机。

![](https://cdn.jsdelivr.net/gh/clint-sfy/blogcdn@master/stm32/base/20240823112621.png)

## 协议层

#### 通讯的起始和停止信号

在图 SPI通讯时序 中的标号处，`NSS信号线由高变低，是SPI通讯的起始信号`。NSS是每个从机各自独占的信号线， 当从机在自己的NSS线检测到起始信号后，就知道自己被主机选中了，开始准备与主机通讯。在图中的标号处，NSS信号由低变高， 是SPI通讯的停止信号，表示本次通讯结束，从机的选中状态被取消。


